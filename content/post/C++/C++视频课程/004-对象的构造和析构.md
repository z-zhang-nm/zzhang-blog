---
title: "004 对象的构造和析构"
date: 2020-07-07T12:42:15+08:00
categories:
- C++视频课程
tags:
- 对象的构造和析构
keywords:
- tech
#thumbnailImage: //example.com/image.jpg
---

<!--more-->
## 1 构造函数

　　创建类的对象时，常常需要做一些初始化工作，C++提供了构造函数来进行这一工作，它是一种特殊的成员函数，不需要用户来调用它，其在创建对象时自动执行。

### 1.1 定义与调用

1. 函数名与类名相同且可以有参数
2. 没有任何返回类型的声明
3. 一般情况下C++编译器会自动调用构造函数，某些情况下也需要手动调用

### 1.2 构造函数的分类

1. 无参数构造函数，创建对象时只写变量名会调用`类A a`，注意变量名后不用写括号
2. 有参数构造函数
3. 拷贝(赋值)构造函数`类A(const 类A& obj) {}`

### 1.3 调用有参数构造函数的三种方法  

> `Test(int a, int b) {}`

1. 括号法`Test t1(1,2)`，自动调用
2. 等号法`Test t2 = (3,4,5,6)`，c++对等号符功能增强，会调用只有一个参数的构造函数，参数传递逗号表达式最后一个元素（逗号表达式最后一个值为整个表达式的值）
3. 直接调用构造函数`Test t3 = Test(1,2)`，手动调用，会产生一个匿名对象

### 1.3 拷贝构造函数的调用时机

```cpp
Test t0(1,2);
Test t1(1,2);
t1 = t0;//用t0给t1赋值， 不会调用拷贝构造函数，需要重载等号操作
```

1. `Test t2 = t0;`
2. `Test t2(t0);`
3. 实参初始化形参的时候会调用类的拷贝构造函数
4. 函数返回值是一个元素（复杂类型），返回的是一个新的匿名对象，所以调用匿名对象类的拷贝构造函数

```cpp
void func1(){
    func2();//3.1 匿名对象并未被使用，接着调用其析构函数
    Test t = func2();//3.2 匿名对象用于初始化t，直接将匿名对象转成t，匿名对象不会被析构，也不会再调用拷贝构造函数
    Test t1(1,2);
    t1 = func2();//3.3 调用类的等号操作，匿名对象被析构
}
Test func2() {
    Test T;
    return T;//1.用T创建一个匿名对象，执行拷贝构造函数 2.析构T
}
void mian(){
    func1();
}
```

### 1.4 默认构造函数

1. 默认无参构造函数：当类中没有定义构造函数时，编译器提供一个无参构造函数，函数体为空
2. 默认拷贝构造函数：当类中没有定义拷贝构造函数时，编译器提供一个默认拷贝构造函数，进行成员变量的值复制（浅拷贝）

### 1.5 构造函数调用规则

1. 当类中没有定义任何一个构造函数时，编译器会提供一个默认无参构造函数和默认拷贝构造函数
2. 当类中定义了拷贝构造函数时，编译器不会提供默认无参构造函数
3. 当类中定义了无参构造函数或有参构造函数，编译器不会提供默认无参构造函数

　　**只要自己写了构造函数，就必须要用！**

### 1.6 浅拷贝

```cpp
class Test {
public:
    Test(const char *p){
        int len = strlen(p);
        len_ = len;
        p_ = (char*)malloc(len+1); //1
        strcpy(p_, p); //2
    }
    ~Test(){
        if(p_ != NULL){
            free(p_);
            p_ = NULL;
            len_ = 0;
        }
    }
private:
    char *p_;
    int len_;
}

void fun(){
    Test t1("abcdefg");
    Test t2 = t1;//3. 默认的拷贝构造函数，拷贝的是指针变量的值
}

void main() {
    fun();
}
```

　　上面的代码运行会崩溃，下面进行分析：

1. ![浅拷贝1](/C++视频课程/004/浅拷贝1.png)
2. ![浅拷贝2](/C++视频课程/004/浅拷贝2.png)
3. ![浅拷贝3](/C++视频课程/004/浅拷贝3.png)

## 2 析构函数

　　进行一些垃圾回收工作。

### 2.1 定义与调用

1. 函数名与类名相同，且函数名前面加一个波浪号
2. 用来清理对象的特殊成员函数
3. 没有参数也没有任何返回类型的声明
4. 对象销毁时自动调用
5. 析构时先构造的对象后释放
